<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <title>House Market Dashboard</title>
  <style>
    :root{--bg:#f7f8fa;--card:#ffffff;--muted:#666;--accent:#2b2b2b;--left-w:280px;--right-w:340px;--gap:12px;--tile-gap:12px}
    html,body{height:100%;margin:0;background:var(--bg);font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color:var(--accent)}
    .wrap{width:92vw;max-width:1600px;height:92vh;margin:18px auto;display:flex;flex-direction:column}
    nav{height:56px;background:#fff;border-radius:8px;padding:8px 14px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 1px 6px rgba(0,0,0,0.06)}
    nav .title{font-weight:600}
    .dashboard{flex:1;display:grid;grid-template-columns:var(--left-w) 1fr var(--right-w);gap:var(--gap);margin-top:12px;align-items:start;min-height:0}
    .panel{background:var(--card);border:1px solid #eee;border-radius:8px;padding:10px;box-sizing:border-box;overflow:hidden;display:flex;flex-direction:column;min-height:0;height:auto}
    .center{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--tile-gap);align-content:start;min-height:0;overflow:auto;padding:6px}
    .tile{background:var(--card);border:1px solid #eee;border-radius:8px;padding:8px;display:flex;flex-direction:column;box-sizing:border-box;overflow:hidden;aspect-ratio:1/1}
    .tile-title{font-size:13px;margin-bottom:8px;color:#222}
    .tile-body{flex:1;display:flex;align-items:center;justify-content:center;padding:6px;overflow:hidden}
    .tile-body img{max-width:100%;max-height:100%;width:100%;height:100%;object-fit:contain;border-radius:6px;cursor:pointer}
    .tile.span2col{grid-column:span 2}
    .tile.span2row{grid-row:span 2}
    .left .stats-list{display:flex;flex-direction:column;gap:10px;padding-right:6px}
    .stat{background:#fafafa;border:1px solid #f0f0f0;padding:10px;border-radius:6px;display:flex;flex-direction:column;justify-content:center;align-items:flex-start}
    .stat-label{font-size:12px;color:var(--muted)}
    .stat-value{font-weight:700;font-size:16px;margin-top:6px}
    .recent-list{overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px;max-height:100% ; scrollbar-width:thin;-ms-overflow-style:thin}
    .recent-list::-webkit-scrollbar{width:8px;height:8px}
    .recent-list::-webkit-scrollbar-thumb{background:#cfcfcf;border-radius:4px}
    .recent-list::-webkit-scrollbar-track{background:transparent}
    .recent-item{display:flex;gap:8px;padding:8px;border-radius:6px;text-decoration:none;color:inherit;border:1px solid #f2f2f2;background:#fff;align-items:center}
    .thumb{width:64px;height:48px;background-size:cover;background-position:center;border-radius:4px;background-color:#eee;flex:0 0 auto}
    .addr{font-size:13px;font-weight:600}
    .meta2{font-size:12px;color:var(--muted)}
    .muted{font-size:11px;color:#999;margin-top:6px}
    .footer-link{font-size:13px;color:#333;text-decoration:none;padding:6px 10px;border-radius:6px;background:#f0f0f0;border:1px solid #e6e6e6}
    .lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;padding:20px}
    .lightbox.open{display:flex}
    .lightbox-content{position:relative;max-width:1100px;max-height:90vh;padding:10px;border-radius:8px;background:#fff;display:flex;flex-direction:column;align-items:center}
    .lightbox-content img{max-width:100%;max-height:80vh;object-fit:contain;border-radius:6px}
    .lightbox-caption{margin-top:8px;color:#333;font-size:14px;max-width:90vw;text-align:center}
    .lightbox-close{position:absolute;top:8px;right:8px;background:#fff;border:0;font-size:22px;cursor:pointer;padding:6px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
  </style>
</head>
<body>
<div class='wrap'>
  <nav>
    <div class='title'>House Market Dashboard</div>
    <div>
      <a class='footer-link' href='/houses'>All houses</a>
      <a class='footer-link' href='/assistant'>AI Assistant</a>
    </div>
  </nav>
  <div class='dashboard'>
    <!-- Left stats -->
    <div class='panel left'>
      <div style='font-weight:600;margin-bottom:8px'>Summary statistics</div>
      <div class='stats-list'>
        {% for stat in stats_html %}
          <div class='stat'>
            <div class='stat-label'>{{ stat.label }}</div>
            <div class='stat-value'>{{ stat.value }}</div>
          </div>
        {% endfor %}
      </div>
    </div>
    <!-- Center graphs -->
    <div class='panel center'>
      {% set tile_list = [
        ("Price per Sqft vs Beds", plot_uris.price_per_sqft_vs_beds),
        ("Boxplot Price by Type", plot_uris.boxplot_price_by_type),
        ("Boxplot Price/Sqft by Type", plot_uris.boxplot_ppsqft_by_type),
        ("Histogram Sqft", plot_uris.hist_sqft),
        ("Bar Avg Price by Beds", plot_uris.bar_avg_price_by_beds),
        ("Line Price Time", plot_uris.line_price_time),
        ("Boxplot Sqft by Type", plot_uris.boxplot_sqft_by_type),
        ("Scatter Price vs Beds", plot_uris.scatter_price_vs_beds),
        ("Price distribution", plot_uris.price_dist),
        ("Bedrooms distribution", plot_uris.beds),
        ("Property type share", plot_uris.ptype),
        ("Price vs sqft", plot_uris.sqft)
      ] %}
      {% for title, uri in tile_list %}
        {% if uri %}
          <div class='tile'><div class='tile-title'>{{ title }}</div><div class='tile-body'><img src='{{ uri }}' alt='{{ title }}'></div></div>
        {% else %}
          <div class='tile'><div class='tile-title'>{{ title }}</div><div class='tile-body'><div class='muted'>No data</div></div></div>
        {% endif %}
      {% endfor %}
    </div>
    <!-- Right recent listings -->
    <div class='panel right'>
      <div style='font-weight:600;margin-bottom:8px'>Recent listings</div>
      <div class='recent-list'>
        {% if recent_listings %}
          {% for p in recent_listings %}
            <a class='recent-item' href='{{ p.url }}' target='_blank'>
              <div class='thumb' style="background-image: url('{{ p.thumb }}');"></div>
              <div class='meta'>
                <div class='addr'>{{ p.addr }}</div>
                <div class='meta2'>{{ p.price }} · {{ p.beds }} beds · {{ p.sqft }} sqft</div>
                <div class='muted'>{{ p.days }}</div>
              </div>
            </a>
          {% endfor %}
        {% else %}
          <div class='muted'>No recent listings available.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <!-- Lightbox and JS as before -->
  <div id='lightbox' class='lightbox' aria-hidden='true'>
    <div class='lightbox-content' role='dialog' aria-modal='true'>
      <button id='lightbox-close' class='lightbox-close' aria-label='Close'>&times;</button>
      <img id='lightbox-img' src='' alt=''>
      <div id='lightbox-caption' class='lightbox-caption'></div>
    </div>
  </div>
  <script>
    (function(){
      const lightbox = document.getElementById('lightbox');
      const lbImg = document.getElementById('lightbox-img');
      const caption = document.getElementById('lightbox-caption');
      const closeBtn = document.getElementById('lightbox-close');
      document.querySelectorAll('.tile .tile-body img').forEach(function(img){
        img.addEventListener('click', function(){
          lbImg.src = this.src;
          caption.textContent = this.alt || '';
          lightbox.classList.add('open');
          lightbox.setAttribute('aria-hidden','false');
          document.body.style.overflow = 'hidden';
        });
      });
      lightbox.addEventListener('click', function(e){
        if(e.target === lightbox || e.target === closeBtn){
          lightbox.classList.remove('open');
          lightbox.setAttribute('aria-hidden','true');
          document.body.style.overflow = '';
        }
      });
      closeBtn.addEventListener('click', function(){
        lightbox.classList.remove('open');
        lightbox.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
      });
      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape'){
          lightbox.classList.remove('open');
          lightbox.setAttribute('aria-hidden','true');
          document.body.style.overflow = '';
        }
      });
    })();
    function syncHeights(){
      try{
        const left = document.querySelector('.panel.left');
        const right = document.querySelector('.panel.right');
        const center = document.querySelector('.panel.center');
        if(!left || !right) return;
        const leftContentHeight = left.scrollHeight;
        right.style.height = leftContentHeight + 'px';
        if(center){
          center.style.maxHeight = '';
          center.style.overflow = '';
        }
      }catch(e){console.warn('syncHeights error',e)}
    }
    window.addEventListener('load', function(){ syncHeights(); setTimeout(syncHeights,300); });
    window.addEventListener('resize', function(){ syncHeights(); });
  </script>
</div>
</body>
</html>
